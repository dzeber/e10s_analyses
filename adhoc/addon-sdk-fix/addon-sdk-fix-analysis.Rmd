---
title: Impact of add-on SDK fix
date: Updated `r format(Sys.Date(), "%B %d, %Y")`
output:
    html_document:
        theme: flatly
        toc: true
        toc_float: true
---

```{r setup, include = FALSE}
options(stringsAsFactors = FALSE)
library(feather)
library(rjson)
library(data.table)
library(ggplot2)

## ggplot theme: light.
theme_set(theme_light())

## Format large numbers as a string, using the comma to separate thousands.
bigNum <- function(nums) {
    prettyNum(nums, big.mark = ",")
}

## Convenience functions for ggplot2.
devtools::source_url("https://raw.githubusercontent.com/dzeber/work-tools/master/R/utils/ggplot.R")
```

First, load the table of MPC add-ons and identify those most affected by the fix.

```{r addons-table, eval = FALSE}
addonsDT <- fread("addons-mpc.csv")
## Change "None" to NA.
for(col in names(addonsDT)) {
    addonsDT[get(col) == "None", eval(col) := NA]
}
## Convert boolean columns to logical (loaded as character because of "None"s)
## via numeric (since "TRUE/FALSE" strings were loaded as "1"/"0").
bool_cols <- c("node_modules", "packages", "package_json")
addonsDT[, eval(bool_cols) :=
    lapply(bool_cols, function(col) { as.logical(as.numeric(get(col))) })]
## Add-ons affected by the fix have package_json TRUE and large numbers of
## JS files.
affectedAddonsDT <- addonsDT[package_json == TRUE,
    list(guid = id, users, js_files,
        name = sub("^([^/]*/)+([^-]+)(.*)$", "\\2", download_url))]
save(addonsDT, affectedAddonsDT, file = "addons-tables.RData")
```

Load and format the data. It is split across 3 data tables:

- `main` with one row per session containing scalar measures
- `addons` with one row per add-on per session
- `hangs` with one row per hang time (histogram bin) per session

```{r load-data, eval = FALSE}
datadir <- "addon-sdk-fix-data_2016-11-01"
dt_main <- as.data.table(read_feather(file.path(datadir, "main.feather")))
dt_addons <- as.data.table(read_feather(file.path(datadir, "addons.feather")))
dt_hangs <- as.data.table(read_feather(file.path(datadir, "hangs.feather")))

## Reformat some columns for convenience.
dt_main[, build_date := as.Date(substr(build_id, 1, 8), format = "%Y%m%d")]
## Ignore versions for Mac and Linux.
dt_main[sys_os != "Windows_NT", sys_os_version := NA]

## Identify add-ons of interest.

## Categorize add-ons according to the number of JS files:
## 50+ (heavy), 20-50 (medium), all (affected).
affectedAddonsDT[, heavy_js := js_files >= 50][,
    medium_js := js_files >= 20 & js_files < 50][,
    affected := TRUE]
setkey(affectedAddonsDT, guid)
setkey(dt_addons, guid)
dt_addons_cols <- names(dt_addons)
affected_addons_cols <- c("heavy_js", "medium_js", "affected")
dt_addons <- affectedAddonsDT[dt_addons,
    c(dt_addons_cols, affected_addons_cols), with = FALSE]
for(acol in affected_addons_cols)
    dt_addons[is.na(get(acol)), eval(acol) := FALSE]
## Identify VDH 6.1.1 separately.
dt_addons[, is_vdh := (guid == "{b9db16a4-6edc-47ec-a1f4-b86292ed211d}" &
    substr(version, 1, 5) == "6.1.1")]

### TODO: found num_addons_nonsys != 0 for a session with no entry in dt_addons.
### something weird is going on

## Summarize each sessions add-ons according to whether they had affected
## add-ons.
session_addons <- dt_addons[, list(has_vdh = any(is_vdh),
    num_addons_affected = sum(affected),
    num_addons_medium_js = sum(medium_js),
    num_addons_heavy_js = sum(heavy_js)),
    keyby = session_id]
setkey(dt_main, session_id)
dt_main <- session_addons[dt_main]
dt_main[is.na(has_vdh), has_vdh := FALSE]
for(acol in grep("^num_addons", names(session_addons), value = TRUE))
    dt_main[is.na(get(acol)), eval(acol) := 0]

save(list = ls(pattern = "^dt_"), file = "addon-sdk-working-data.RData")
```

What are the features of our client population?

```{r client-submissions}
## Number of sessions per client.
nsess_dist <- dd[, list(nsess = .N), by = client_id][, Ecdf(nsess)]
## Remove dummy first row.
nsess_dist <- nsess_dist[-1]
setnames(nsess_dist, c("num_sessions", "p"))
qplot(num_sessions, p, data = nsess_dist, geom = "point") + geom_line() +
    scale_x_continuous(breaks = interval.breaks(10), limits = c(0, 50)) +
    scale_y_continuous(breaks = interval.breaks(0.1), labels = pct.labels,
        limits = c(0, 1)) +
        labs(title = "ECDF of # submissions per client",
            x = "N = # submissions",
            y = "% of clients with at most N submissions")
```

How many clients have e10s, addons, and are present in both periods?

```{r client-features}
client_feats <- dd[, { d <- list()
    e10s <- unique(e10s)
    d[["e10s"]] <- if(length(e10s) == 2) "both" else c("off", "on")[e10s + 1]
    num_addons <- unique(addons_nonsys_num)
    d[["addons"]] <- if(length(num_addons) > 1) "changes" else {
        if(num_addons == 0) "none" else {
            ## Every session has the same number of add-ons.
            ## Check if they're all the same.
            addons_str <- lapply(addons_nonsys, function(alist) {
                as.character(lapply(alist, paste, collapse = ":")) })
            if(length(unique(unlist(addons_str))) == length(addons_str[[1]])) {
                "fixed" } else { "changes" }
        }
    }
    periods <- unique(period)
    d[["periods"]] <- if(length(periods) == 2) "both" else period
    d }, by = client_id]
client_feats <- unique(client_feats)

for(col in c("e10s", "addons", "periods")) {
    cnts <- client_feats[, .N, by = col]
    cnts[, pct := N / sum(N) * 100]
    cnts[, N := bigNum(N)][, pct := sprintf("%.2f", pct)]
    print(cnts)
    cat("\n\n")
}
```

How many sessions have weird startup times?

```{r startup-san}
startup_cols <- grep("^startup", names(dd), value = TRUE)

## Check for missing values.
na_startup <- dd[, setNames(lapply(startup_cols, function(scol) { is.na(get(scol)) }),
   sprintf("na_%s", startup_cols))]
na_startup[, na_any := Reduce("|", as.list(na_startup))]
cat("Percentages with missing values: \n")
print(lapply(na_startup, function(vals) { mean(vals) * 100 }))

## Check for negatives.
neg_startup <- dd[, setNames(lapply(startup_cols,
    function(scol) { scol <- get(scol); !is.na(scol) & scol < 0 }),
    sprintf("neg_%s", startup_cols))]
neg_startup[, neg_any := Reduce("|", as.list(neg_startup))]
cat("Percentages with negative values: \n")
print(lapply(neg_startup, function(vals) { mean(vals) * 100 }))

## Remove weird values.
dd <- dd[na_startup[, !na_any] & neg_startup[, !neg_any]]
```

Are times ordered as we expect?

```{r time-order}
cat("How many sessions fail to have main <= toplevelwindow <= firstpaint?\n")
unordered <- nrow(dd[!(startup_main <= startup_toplevelwindow &
    startup_toplevelwindow <= startup_firstpaint)])
cat(sprintf("%s (%.2f%%)\n", bigNum(unordered), unordered / nrow(dd) * 100))

cat("\nHow many sessions fail to have firstpaint <= sessionrestored?\n")
unordered <- nrow(dd[startup_firstpaint > startup_sessionrestored])
cat(sprintf("%s (%.2f%%)\n", bigNum(unordered), unordered / nrow(dd) * 100))

cat("\nHow many sessions fail to have AMI_begin <= AMI_end?\n")
unordered <- nrow(dd[startup_AMIstart > startup_AMIend])
cat(sprintf("%s (%.2f%%)\n", bigNum(unordered), unordered / nrow(dd) * 100))

## Remove those with out-of-order AMI timestamps.
dd <- dd[startup_AMIstart <= startup_AMIend]
```

Summarize startup times using the median for each client.
```{r startup-plot}
startup_client <- dd[, setNames(lapply(startup_cols, function(scol) { median(get(scol)) }),
    startup_cols), by = list(e10s, has_addons = addons_nonsys_num > 0, period, client_id)]
## Take sample of clients in each cell.
startup_samp <- startup_client[, if(.N > 500) .SD[sample.int(.N, 500)] else .SD,
    by = list(e10s, has_addons, period)]

milestones <- c("main", "AMIstart", "AMIend", "toplevelwindow", "firstpaint", "sessionrestored")
startup_gg <- startup_samp[, list(milestone = milestones,
    time_ms = as.numeric(.SD[1, sprintf("startup_%s", milestones), with = FALSE])),
    by = list(e10s, has_addons, period, client_id)]
startup_gg[, milestone := factor(milestone, levels = milestones)]
startup_gg[, facet := sprintf("e10s %s, %saddons", c("off", "on")[e10s + 1],
    c("no ", "")[has_addons + 1])]
    
```

