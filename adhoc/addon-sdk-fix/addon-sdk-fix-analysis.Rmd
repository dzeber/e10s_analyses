---
title: Impact of add-on SDK fix
date: Updated `r format(Sys.Date(), "%B %d, %Y")`
output:
    html_document:
        theme: flatly
        toc: true
        toc_float: true
---

```{r setup, include = FALSE}
## Knitr options:
## - wider figures
knitr::opts_chunk$set(
    fig.width = 9,
    fig.height = 5
)

options(stringsAsFactors = FALSE)
library(feather)
#library(rjson)
library(data.table)
library(ggplot2)
library(Hmisc)

## ggplot theme: light.
theme_set(theme_light())

## Format large numbers as a string, using the comma to separate thousands.
bigNum <- function(nums) {
    prettyNum(nums, big.mark = ",")
}

## Convert proportions to a percentage formatted as a string.
## Specify the number of decimal places to include.
pctLabelText <- function(props, dec = 1) {
    sprintf(sprintf("%%.%df%%%%", dec), props * 100)
}

## Convenience functions for ggplot2.
devtools::source_url("https://raw.githubusercontent.com/dzeber/work-tools/master/R/utils/ggplot.R")
```

First, load the table of MPC add-ons and identify those most affected by the fix.

```{r addons-table, eval = FALSE}
addonsDT <- fread("addons-mpc.csv")
## Change "None" to NA.
for(col in names(addonsDT)) {
    addonsDT[get(col) == "None", eval(col) := NA]
}
## Convert boolean columns to logical (loaded as character because of "None"s)
## via numeric (since "TRUE/FALSE" strings were loaded as "1"/"0").
bool_cols <- c("node_modules", "packages", "package_json")
addonsDT[, eval(bool_cols) :=
    lapply(bool_cols, function(col) { as.logical(as.numeric(get(col))) })]
## Add-ons affected by the fix have package_json TRUE and large numbers of
## JS files.
affectedAddonsDT <- addonsDT[package_json == TRUE,
    list(guid = id, users, js_files,
        name = sub("^([^/]*/)+([^-]+)(.*)$", "\\2", download_url))]
save(addonsDT, affectedAddonsDT, file = "addons-tables.RData")
```

Load and format the data. It is split across 3 data tables:

- `main` with one row per session containing scalar measures
- `addons` with one row per add-on per session
- `hangs` with one row per hang time (histogram bin) per session

```{r load-data, eval = FALSE}
datadir <- "addon-sdk-fix-data_2016-11-02"
dt_main <- as.data.table(read_feather(file.path(datadir, "main.feather")))
dt_addons <- as.data.table(read_feather(file.path(datadir, "addons.feather")))
dt_hangs <- as.data.table(read_feather(file.path(datadir, "hangs.feather")))

## Reformat some columns for convenience.
dt_main[, build_date := as.Date(substr(build_id, 1, 8), format = "%Y%m%d")]
## Ignore versions for Mac and Linux.
dt_main[sys_os != "Windows_NT", sys_os_version := NA]

## Identify add-ons of interest.

## Categorize add-ons according to the number of JS files:
## 50+ (heavy), 20-50 (medium), all (affected).
affectedAddonsDT[, heavy_js := js_files >= 50][,
    medium_js := js_files >= 20 & js_files < 50][,
    affected := TRUE]
setkey(affectedAddonsDT, guid)
setkey(dt_addons, guid)
dt_addons_cols <- names(dt_addons)
affected_addons_cols <- c("heavy_js", "medium_js", "affected")
dt_addons <- affectedAddonsDT[dt_addons,
    c(dt_addons_cols, affected_addons_cols), with = FALSE]
for(acol in affected_addons_cols)
    dt_addons[is.na(get(acol)), eval(acol) := FALSE]
## Identify VDH 6.1.1 separately.
dt_addons[, is_vdh := (guid == "{b9db16a4-6edc-47ec-a1f4-b86292ed211d}" &
    substr(version, 1, 5) == "6.1.1")]

## Summarize each sessions add-ons according to whether they had affected
## add-ons.
session_addons <- dt_addons[, list(has_vdh = any(is_vdh),
    num_addons_affected = sum(affected),
    num_addons_medium_js = sum(medium_js),
    num_addons_heavy_js = sum(heavy_js)),
    keyby = session_id]
setkey(dt_main, session_id)
dt_main <- session_addons[dt_main]
dt_main[is.na(has_vdh), has_vdh := FALSE]
for(acol in grep("^num_addons", names(session_addons), value = TRUE))
    dt_main[is.na(get(acol)), eval(acol) := 0]

rm(dt_addons_cols)
save(list = ls(pattern = "^dt_"), file = "addon-sdk-working-data.RData")
```

```{r load-from-rdata}
load("addons-tables.RData")
load("addon-sdk-working-data.RData")
```

Focus first on "good" profiles, that were active both before and after the change, and had a constant e10s setting and list of active add-ons (ignoring add-on versions) throughout.

```{r good-prof}
dt_good <- dt_main[both_periods & constant_e10s & constant_addons_guid]
nprof_good <- dt_good[, length(unique(client_id))]
```

We have `bigNum(nprof_good)` such profiles
(`pctLabelText(nprof_good / dt_main[, length(unique(client_id))])`) with a total of
`bigNum(nrow(dt_good))` (`pctLabelText(nrow(dt_good) / nrow(dt_main))`) sessions.

How many sessions have e10s enabled, and have add-ons?

```{r good-prof-counts}
dt_good[, list(n_sessions = .N), by = list(e10s, has_addons = num_addons_nonsys > 0)][
    order(e10s, has_addons, decreasing = TRUE)][,
    pct_sessions := pctLabelText(n_sessions / nrow(dt_good))][,
    n_sessions := bigNum(n_sessions)][]
```

For those sessions that have add-ons, how many have add-ons most affected by the changes, and specifically VDH?

```{r good-prof-counts-addons}
dt_good[num_addons_nonsys > 0, list(n_sessions = .N),
    by = list(has_addons_affected = num_addons_affected > 0, has_addons_medium_js = num_addons_medium_js > 0,
        has_addons_heavy_js = num_addons_heavy_js > 0, has_vdh)][
    order(has_addons_affected, has_addons_medium_js, has_addons_heavy_js, has_vdh)][,
    pct_sessions := pctLabelText(n_sessions / nrow(dt_good))][,
    n_sessions := bigNum(n_sessions)][]
```

Compare the hang stats before and after for each profile.
Summarize a session's hang times by the mean of log times reported during that session.
Count a session with no hangs as 0.

```{r good-prof-hangs}
dt_hangs_mean <- dt_hangs[, list(hang_time = wtd.mean(log(hang_time + 1, 2), count)), keyby = session_id]
setkey(dt_good, session_id)
dt_good <- dt_hangs_mean[dt_good]
dt_good[is.na(hang_time), hang_time := 0]
## Drop sessions with interrupted startup.
dt_good <- dt_good[was_startup_interrupted == FALSE]
## Order the period labels for display.
dt_good[, period := factor(period, levels = c("before", "after"))]
## Add indicators for add-ons.
dt_good[, has_addons := factor(ifelse(num_addons_nonsys > 0, "has addons", "no addons"), levels = c("has addons", "no addons"))]#[,
#    has_addons_affected := num_addons_affected > 0][,
#    has_addons_medium_js := num_addons_medium_js > 0][,
#    has_addons_heavy_js := num_addons_heavy_js > 0]
dt_good[, e10s_state := factor(ifelse(e10s, "e10s on", "e10s off"), levels = c("e10s on", "e10s off"))]

```

Are there differences in per-session hang times?
Separate sessions with hangs from those without.

```{r good-hang-diff-session-box, fig.height = 9}
## Boxplots of hang times for sessions with hangs.
ggplot(dt_good[has_hangs == TRUE], aes(period, hang_time)) +
    geom_boxplot() +
    ## Expand over range of possible hang times.
    #expand_limits(y = dt_hangs[, range(log(hang_time + 1, 2)) + c(-1, 1)]) +
    facet_grid(e10s_state ~ has_addons) +
    labs(title = "Per-session mean hang (runner.js) times before and after the change\nfor sessions with hangs",
        x = "Period",
        y = "log2(hang time)")
```
```{r good-hang-diff-session-pct, fig.height = 7}
## Proportions of sessions without hangs.
ggplot(dt_good[, list(prop_hangs = mean(has_hangs)), by = list(e10s_state, has_addons, period)],
        aes(factor(period, levels = rev(levels(period))), prop_hangs)) +
    geom_bar(stat = "identity") + #coord_flip() +
    facet_grid(e10s_state ~ has_addons) +
    scale_y_continuous(breaks = interval.breaks(0.2), labels = pct.labels,
        limits = c(0,1)) +
    labs(title = "Percentage of sessions with hangs (runner.js)",
        x = "Period",
        y = "Percent of sessions")
```

Look into the per-client before/after differences.

```{r good-hang-diff-prof-overall-box, fig.height = 7}
## Many columns should have the same value across all sessions for a given client.
per_client_cols <- c("e10s", "e10s_state", "num_addons_nonsys", "num_addons_affected",
    "num_addons_medium_js", "num_addons_heavy_js", "has_vdh",
    grep("^sys", names(dt_good), value = TRUE))
dt_good_prof <- dt_good[, c(list(hang_time = mean(hang_time[period == "after"]) - mean(hang_time[period == "before"]),
    has_hangs = any(has_hangs)),
    setNames(lapply(per_client_cols, function(ccol) { get(ccol)[1] }), per_client_cols)),
    by = client_id]

## Make boxplots of differences according to add-on types and e10s status, for profiles that had hangs.
dt_good_prof[, addon_type := factor(ifelse(num_addons_nonsys == 0, "no addons",
    ifelse(num_addons_affected == 0, "addons,\nno affected",
    ifelse(num_addons_heavy_js == 0, "has affected,\nno heavy-js",
    ifelse(!has_vdh, "has heavy-js", "has VDH")))),
    levels = c("no addons", "addons,\nno affected", "has affected,\nno heavy-js",
        "has heavy-js", "has VDH"))]

plot_diff_addon <- function() {
    ggplot(dt_good_prof[has_hangs == TRUE], aes(addon_type, hang_time)) +
        geom_boxplot() +
        geom_hline(yintercept = 0, size = 0.5, colour = "blue") +
        scale_y_continuous(breaks = interval.breaks(4)) +
        labs(title = "(After - before) difference in client mean hang (runner.js) times\nfor clients with hangs (negative means improvement)",
            x = "Client's add-ons type",
            y = "Difference in log2(hang time)")
}
plot_diff_addon() + facet_wrap(~e10s_state)
```

```{r good-hang-diff-prof-overall-pct}
## Also plot the corresponding proportions of clients with hangs.
dt_good_prop_hangs <- dt_good_prof[, list(has_hangs = mean(has_hangs)),
    by = list(e10s_state, addon_type)]
plot_prop_addon <- function() {
    ggplot(dt_good_prop_hangs, aes(addon_type, has_hangs)) +
        geom_bar(stat = "identity") +
        scale_y_continuous(breaks = interval.breaks(0.2), labels = pct.labels,
            limits = c(0,1)) +
        labs(title = "Percentage of clients with hangs (runner.js)",
            x = "Client's add-ons type",
            y = "Percent of clients")
}
plot_prop_addon() + facet_wrap(~e10s_state)
```

```{r good-hang-diff-prof-sys-box, fig.height = 16}
## Same but split out by system config.
dt_good_prof[, sys_os := factor(sys_os, levels = c("Windows_NT", "Darwin", "Linux"))][,
    sys_arch := factor(sys_arch, levels = c("x86", "x86-64"))]
sys_arch_label <- function(os, arch) { sprintf("%s (%s)", os, arch) }
sys_arch_levels <- dt_good_prof[, .N, by = list(sys_os, sys_arch)][order(sys_os, sys_arch)][,
    sys_arch_label(sys_os, sys_arch)]
dt_good_prof[, sys_os_arch := factor(sys_arch_label(sys_os, sys_arch), levels = sys_arch_levels)]

plot_diff_addon() + facet_grid(sys_os_arch ~ e10s_state) +
    ggtitle("(After - before) difference in client mean hang (runner.js) times\nfor clients with hangs\nby system config (negative means improvement)")
```

```{r good-hang-diff-prof-sys-pct, fig.height = 14, eval = FALSE}
dt_good_prop_hangs <- dt_good_prof[, list(has_hangs = mean(has_hangs)),
    by = list(e10s_state, addon_type, sys_os_arch)]
plot_prop_addon() + facet_grid(sys_os_arch ~ e10s_state) +
    ggtitle("Percentage of clients with hangs (runner.js)\nby system config")
```



--------------

<!--
What are the features of our client population?

```{r client-submissions, eval = FALSE}
## Number of sessions per client.
nsess_dist <- dd[, list(nsess = .N), by = client_id][, Ecdf(nsess)]
## Remove dummy first row.
nsess_dist <- nsess_dist[-1]
setnames(nsess_dist, c("num_sessions", "p"))
qplot(num_sessions, p, data = nsess_dist, geom = "point") + geom_line() +
    scale_x_continuous(breaks = interval.breaks(10), limits = c(0, 50)) +
    scale_y_continuous(breaks = interval.breaks(0.1), labels = pct.labels,
        limits = c(0, 1)) +
        labs(title = "ECDF of # submissions per client",
            x = "N = # submissions",
            y = "% of clients with at most N submissions")
```
-->

<!--
How many sessions have weird startup times?

```{r startup-san, eval = FALSE}
startup_cols <- grep("^startup", names(dd), value = TRUE)

## Check for missing values.
na_startup <- dd[, setNames(lapply(startup_cols, function(scol) { is.na(get(scol)) }),
   sprintf("na_%s", startup_cols))]
na_startup[, na_any := Reduce("|", as.list(na_startup))]
cat("Percentages with missing values: \n")
print(lapply(na_startup, function(vals) { mean(vals) * 100 }))

## Check for negatives.
neg_startup <- dd[, setNames(lapply(startup_cols,
    function(scol) { scol <- get(scol); !is.na(scol) & scol < 0 }),
    sprintf("neg_%s", startup_cols))]
neg_startup[, neg_any := Reduce("|", as.list(neg_startup))]
cat("Percentages with negative values: \n")
print(lapply(neg_startup, function(vals) { mean(vals) * 100 }))

## Remove weird values.
dd <- dd[na_startup[, !na_any] & neg_startup[, !neg_any]]
```

Are times ordered as we expect?

```{r time-order, eval = FALSE}
cat("How many sessions fail to have main <= toplevelwindow <= firstpaint?\n")
unordered <- nrow(dd[!(startup_main <= startup_toplevelwindow &
    startup_toplevelwindow <= startup_firstpaint)])
cat(sprintf("%s (%.2f%%)\n", bigNum(unordered), unordered / nrow(dd) * 100))

cat("\nHow many sessions fail to have firstpaint <= sessionrestored?\n")
unordered <- nrow(dd[startup_firstpaint > startup_sessionrestored])
cat(sprintf("%s (%.2f%%)\n", bigNum(unordered), unordered / nrow(dd) * 100))

cat("\nHow many sessions fail to have AMI_begin <= AMI_end?\n")
unordered <- nrow(dd[startup_AMIstart > startup_AMIend])
cat(sprintf("%s (%.2f%%)\n", bigNum(unordered), unordered / nrow(dd) * 100))

## Remove those with out-of-order AMI timestamps.
dd <- dd[startup_AMIstart <= startup_AMIend]
```

Summarize startup times using the median for each client.
```{r startup-plot, eval = FALSE}
startup_client <- dd[, setNames(lapply(startup_cols, function(scol) { median(get(scol)) }),
    startup_cols), by = list(e10s, has_addons = addons_nonsys_num > 0, period, client_id)]
## Take sample of clients in each cell.
startup_samp <- startup_client[, if(.N > 500) .SD[sample.int(.N, 500)] else .SD,
    by = list(e10s, has_addons, period)]

milestones <- c("main", "AMIstart", "AMIend", "toplevelwindow", "firstpaint", "sessionrestored")
startup_gg <- startup_samp[, list(milestone = milestones,
    time_ms = as.numeric(.SD[1, sprintf("startup_%s", milestones), with = FALSE])),
    by = list(e10s, has_addons, period, client_id)]
startup_gg[, milestone := factor(milestone, levels = milestones)]
startup_gg[, facet := sprintf("e10s %s, %saddons", c("off", "on")[e10s + 1],
    c("no ", "")[has_addons + 1])]
    
```
-->
