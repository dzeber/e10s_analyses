queries:
- api_key: ac651fbb9ef43be31d0415548c3b3042828b0f88
  data_source: Presto
  description: In Release 49, 100% of the eligible population should be placed in
    the test cohorts (no control)
  id: 1245
  name: Daily proportion of Release 49 usage in e10s cohorts
  query: |
    WITH channel_data AS (
      /* Restrict to population and dates of interest */
      SELECT *
      FROM crash_aggregates
      WHERE
      -- Dates start from the release of Release 49
      submission_date >= '2016-09-20'
      AND activity_date >= '2016-09-20'
      -- Fx Release 49
      AND dimensions['application'] = 'Firefox'
      AND dimensions['channel'] = 'release'
      AND dimensions['build_version'] like '49.%'
      -- No active experiment
      AND dimensions['experiment_id'] IS NULL
    ),
    usage_by_cohort_and_date AS (
      /* Total usage hours by activity date and cohort */
      SELECT
      activity_date,
      dimensions['e10s_cohort'] AS e10s_cohort,
      SUM(stats['usage_hours']) AS usage_hours
      FROM channel_data
      GROUP BY 1, 2
    ),
    usage_by_date AS (
      /* Total usage hours by date only */
      SELECT
      activity_date,
      SUM(usage_hours) AS total_usage_hours
      FROM usage_by_cohort_and_date
      GROUP BY 1
    ),
    usage_by_cohort_with_totals AS (
      SELECT
      ubcad.*,
      total_usage_hours
      FROM usage_by_cohort_and_date AS ubcad
      JOIN usage_by_date AS ubd
        ON ubcad.activity_date = ubd.activity_date
    ),
    /* Proportion of usage by cohort and date */
    usage_props AS (
      SELECT
      activity_date,
      e10s_cohort,
      usage_hours,
      usage_hours / total_usage_hours as usage_prop
      FROM usage_by_cohort_with_totals
    )
    /* Total usage hours and proportions for cohorts with and without add-ons.
     * Note that there is no control group in Release 49.
     */
    SELECT
    activity_date,
    SUM(CASE WHEN e10s_cohort = 'addons-set49a-test' THEN usage_hours ELSE 0 END)
      AS usage_hours_addons,
    SUM(CASE WHEN e10s_cohort = 'addons-set49a-test' THEN usage_prop ELSE 0 END) * 100
      AS usage_pct_addons,
    SUM(CASE WHEN e10s_cohort = 'test' THEN usage_hours ELSE 0 END)
      AS usage_hours_std,
    SUM(CASE WHEN e10s_cohort = 'test' THEN usage_prop ELSE 0 END) * 100
      AS usage_pct_std
    FROM usage_props
    WHERE
    -- Drop the most recent days as data may be incomplete
    CAST(activity_date AS date) < current_date - interval '2' day
    GROUP BY 1
    ORDER BY 1
  schedule: '86400'
  visualizations:
  - description: ''
    id: 2159
    name: Daily percentage of e10s cohort usage from add-ons test cohort
    options:
      bottomMargin: 50
      columnMapping: {activity_date: x, usage_hours_addons: unused, usage_hours_std: unused,
        usage_pct_addons: y, usage_pct_std: unused}
      globalSeriesType: line
      legend: {enabled: false}
      series: {stacking: null}
      seriesOptions:
        usage_pct_addons: {index: 0, type: line, yAxis: 0, zIndex: 0}
      sortX: true
      xAxis:
        labels: {enabled: true}
        type: datetime
      yAxis:
      - {type: linear}
      - {opposite: true, type: linear}
    type: CHART
  - description: ''
    id: 2158
    name: Daily usage hours for profiles in the e10s add-ons test cohort
    options:
      bottomMargin: 50
      columnMapping: {activity_date: x, usage_hours_addons: y, usage_hours_std: unused,
        usage_pct_std: unused}
      globalSeriesType: line
      legend: {enabled: false}
      series: {stacking: null}
      seriesOptions:
        usage_hours_addons: {index: 0, type: line, yAxis: 0, zIndex: 0}
      sortX: true
      xAxis:
        labels: {enabled: true}
        type: datetime
      yAxis:
      - {type: linear}
      - {opposite: true, type: linear}
    type: CHART
  - description: ''
    id: 2157
    name: Daily usage hours for profiles in the e10s standard test cohort
    options:
      bottomMargin: 50
      columnMapping: {activity_date: x, usage_hours_addons: unused, usage_hours_std: y,
        usage_pct_std: unused}
      globalSeriesType: line
      legend: {enabled: false}
      series: {stacking: null}
      seriesOptions:
        usage_hours_std: {index: 0, type: line, yAxis: 0, zIndex: 0}
      sortX: true
      xAxis:
        labels: {enabled: true}
        type: datetime
      yAxis:
      - {type: linear}
      - {opposite: true, type: linear}
    type: CHART
  - description: ''
    id: 2156
    name: Daily percentage of e10s cohort usage from the standard test cohort
    options:
      bottomMargin: 50
      columnMapping: {activity_date: x, usage_hours_addons: unused, usage_pct_std: y}
      globalSeriesType: line
      legend: {enabled: false}
      series: {stacking: null}
      seriesOptions:
        usage_pct_std: {index: 0, type: line, yAxis: 0, zIndex: 0}
      sortX: true
      xAxis:
        labels: {enabled: true}
        type: datetime
      yAxis:
      - {type: linear}
      - {opposite: true, type: linear}
    type: CHART
